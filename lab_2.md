# Лабораторная работа №1

## Задание 4: Исследуйте соотношение цены и дальности полета для различных типов самолетов и классов обслуживания. Рассчитайте стоимость за километр полета для каждой комбинации модели самолета и класса. Определите наиболее экономичные варианты для пассажиров, а также наиболее выгодные комбинации для авиакомпании с точки зрения выручки.

### Логика решения

1. Оцениваем дальность каждого полета. Будем использовать длительность полета и среднюю скорость.  
2. Соединяем таблицы, чтобы получить модель самолета, класс обслуживания, стоимость билета и дальность.  
3. Вычисляем стоимость за километр (`amount / distance`).  
4. Группируем данные по модели самолета и классу обслуживания.  
   - **Для пассажира:** ищем минимальную среднюю стоимость за км.  
   - **Для авиакомпании:** ищем максимальную среднюю стоимость за км (максимальная выручка с километра).

**Константа:** Принята средняя скорость самолета 850 км/ч.

**SQL-запрос:**
```sql
with flight_details as (
    select
        tf.amount,
        tf.fare_conditions,
        a.model ->>'en' as aircraft_model,
        extract(epoch from (f.scheduled_arrival - f.scheduled_departure)) / 3600 * 850 as distance_km
    from bookings.ticket_flights tf join bookings.flights f on tf.flight_id = f.flight_id join bookings.aircrafts_data a on f.aircraft_code = a.aircraft_code
)
select
    aircraft_model,
    fare_conditions as travel_class,
    count(*) as flights_count,
    round(avg(distance_km)) as avg_distance_km,
    round(avg(amount), 2) as avg_ticket_price,
    round(avg(amount / distance_km), 2) as avg_price_per_km
from flight_details where distance_km > 0
group by aircraft_model, fare_conditions
order by avg_price_per_km asc;
```

### Пояснение

1. **Подготовка данных**
   - Склеиваем три таблицы, чтобы для каждого проданного билета получить его стоимость (`amount`), класс обслуживания (`fare_conditions`), модель самолета (`aircraft_model`) и данные о рейсе.  
   - Так как в базе нет колонки с расстоянием, она вычисляется по формуле:  
     **Длительность полета (в часах) × Средняя скорость (850 км/ч)**.  
     Длительность в часах получаем, извлекая из интервала времени общее число секунд, которое затем делим на 3600.

2. **Агрегация и финальный расчет**
   - С помощью `group by aircraft_model, fare_conditions` объединяются все рассчитанные на первом шаге перелеты в группе.  
   - Для каждой такой группы считаем:  
     - `count(*)`: общее количество билетов в группе.  
     - `avg(distance_km)` и `avg(amount)`: среднее расстояние и среднюю цену билета.  
     - `avg(amount / distance_km)`: среднюю стоимость за километр.  
   - `order by avg_price_per_km asc` сортирует результат от самых дешевых вариантов к самым дорогим.

3. **Итог**
   - То, что на вершине таблицы с самой наименьшей ценой - лучшее предложение для покупателей.  
   - То, что внизу таблицы с самой наивысшей ценой - наиболее выгодные комбинации для авиакомпании с точки зрения выручки.
